\chapter{Grief-free Atomic Swaps}  % Motivation
\label{chapter:swaps}

\section{Introduction}
Before Bitcoin, there was considerable research on the \textit{Fair Exchange Problem}, with its associated impossibility results \cite{cleve1986limits}, \cite{fair_exchange_impossibility}, \cite{franklin1997fair}, \cite{asokan1998optimistic}. Many of these results came about in the quest to remove the \textit{trusted third party} when two parties want to exchange different assets of equal value. Bitcoin created a different kind of trusted third party. Here, both parties trust the Bitcoin blockchain as an arbiter for dispute resolution and as a tamperproof public bulletin board. Fair Exchange, in the Bitcoin setting, is known as the Atomic Swap. It is atomic in the sense that a swap of assets between two parties either goes through fully or not at all. Atomic Swaps were perhaps the first non-trivial smart contracts designed to work on blockchains. Tier Nolan's classic swap (TN-swap, from here on) was discussed on the BitoinTalk forum in 2013 \cite{atomic_swap}. The TN-swap is not atomic from a transaction perspective. The swap requires 4 transactions: 2 HTLCs + (2 redeems or 2 refunds).\footnote{HTLC stands for Hash Timelock Contracts \cite{htlcs_considered_harmful}, and the redeem and refund transactions are part of the HTLC specification.} The atomicity is from a higher abstraction of the swap of assets -- either the swap goes through, and both parties end up with the assets they desire, or it does not, and both parties retain their original assets. These assets could even be on different blockchains, e.g., Bitcoin and Litecoin. If it were a cross-chain atomic swap, both blockchains must be compatible with the primitives used in the swap protocol. 

Atomic swaps could involve various assets: say, someone wants to buy a Sudoku solution for some price. However, these generally involve more complex protocols that convert assets into information that can be transferred on a public blockchain. In the case of a Sudoku, a symmetric key is used to encrypt the solution, and this key is atomically swapped for monetary value, while the encrypted blob is sent off-chain, as seen in ZKCP \cite{maxwell2016zero}. This kind of swap has one of the assets not being scrutinizable on the blockchain and hence has to rely on more complex Zero-Knowledge proofs to convince the buyer that the key encrypts a correct solution. We want to look at a more straightforward class of atomic swaps where one can scrutinize the actual asset being swapped on the blockchain, and the buyer or the swap initiator doesn't need any other data beyond the blockchain. In the base case, these swaps involve the native cryptocurrency of the blockchain(s). In the single blockchain setting, swapping coins of equal value between Alice and Bob can improve both their privacy, as proposed in Coinswap \cite{coinswap}.

TN-swap, which is formally defined in Section \ref{sec:tn_swap}, is atomic but not fair. There are steps in the swap where either Alice or Bob can abort the protocol and put their counterparty at a disadvantage. The counterparty does not lose monetary value (it is an atomic swap, after all) but is either made to wait before they get their asset back or might lose blockchain fees by making extra transactions and such. We refer to the waiting part of this problem as \textit{griefing}. Protocols like Arwen \cite{arwen_protocol} rely on one of the counterparties of the atomic swap caring about protecting their reputation. A few proposals have been made to reduce griefing, but they all involve smart contracts that have access to global state storage. These smart contracts look up the swap state and proceed according to how the swap has gone so far. Some  of these proposals are: Fairswap \cite{fairswap}, Optiswap \cite{optiswap}, Han-Lin-Yu swap (HLY-swap) \cite{atomic_swaps_american_call_options}, and Xue-Herlihy swap (XH-swap) \cite{xue_herlihy_swap}. All these rely on smart contracts and are not compatible with Bitcoin natively. The former two optimize for the \textit{optimstic case}, where the swap is efficient to execute if it goes as expected. In the \textit{pessimistic case}, when the swap does not go through, a more complex dispute resolution protocol is invoked. The latter two are more focused on avoiding our griefing problem and solve it by getting the advantaged party paying a premium\footnote{} to the disadvantaged party. The HLY-swap paper draws parallels between the atomic swap and an American Call Option from traditional finance. In traditional finance, these options are made fair by getting the disadvantaged party to sell the option itself to the advantaged party. The price at which this option is sold is called the option premium. As the advantaged party pays this premium upfront to the disadvantaged party, their privilege to abort the swap is compensated for. Unfortunately, Bitcoin's stack-based execution environment does not allow access to external state storage, and these swaps cannot be directly implemented in Bitcoin natively. Both these swaps can be implemented in Bitcoin if a new opcode is added to it. Done that way, HLY-Swap uses the premium on one side of the swap but allows griefing on the other side. XH-swap avoids griefing on both sides of the swap but allows the premiums themselves to be griefed. Contrary to the claim in the XH-swap paper that griefing cannot be avoided, we present an atomic swap construction without griefing, which can also be implemented in Bitcoin with no changes to Bitcoin itself. Our protocol is also more efficient regarding the number of transactions and the worst-case timelock for which funds are locked.

\section{System Model}
Our system model is based on Bitcoin, with its UTXO (Unspent Transaction Outputs) model. We require primitives like hashes, timelocks, and signatures. Furthermore, we make the following assumptions about the system.
\begin{itemize}
    \item Time proceeds as blocks, and each block is separated by a constant and known unit of real-world time.
    \item All users are online know if specific transactions are confirmed through the public blockchain.
    \item Transactions have constant fees, which are independent of the amounts involved in the transactions.
\end{itemize}
\subsection{Atomic Swap Specification} \label{spec}
The Atomic Swap specification consists of the following:
\begin{itemize}
    \item Two users: Alice and Bob, who want to swap their coins $P_a$ and $P_b$ with each other. These could be on different blockchains or the same blockchain. We call this the principal amount.
    \item A sequence of $n$ transactions $S_{all}$, made up of individual transactions $T_0$, $T_1$, $T_2$, \ldots, $T_{n-1}$, out of which a subset $S_{conf}$ get confirmed on the blockchain.
    \item At the end of $S_{conf}$, \textbf{only one} of the following is true:
    \begin{itemize}
        \item Successful swap: Alice has value equivalent to $P_b$ and Bob has value equivalent to $P_a$. We call this set $S \subset S_{all}$. Note that there is typically a single subset of $S_{all} $ that makes a successful swap.
        \item Unsuccessful swap: Alice has value equivalent to $P_a$ and Bob has value equivalent to $P_b$. We call this set $F \subset S_{all}$. Note that there could be many subsets $F_1, F_2, \ldots$ that make up different failure scenarios of the swap.
    \end{itemize}
\end{itemize}

\subsection{Notation}
We recall that in the UTXO model, every transaction consumes unspent outputs of previous transactions and creates the next set of unspent outputs for other transactions to spend.\footnote{Coinbase transactions are unique transactions that do not have inputs and create new coins.} An unspent transaction output (UTXO) contains the coin value in question and a set of locking conditions. Unlocking conditions will come from the transaction that spends this UTXO. A UTXO can be locked with various primitives like digital signatures, timelocks, knowledge of preimages of hashes, basic arithmetic, and such. Note that the locking conditions and their corresponding unlocking conditions are evaluated together on the stack, and there is no other external input available during this evaluation. Not having access to external state data makes the Bitcoin model \textit{stateless}. Being stateless in this specific way makes designing smart contracts harder.

In this paper, we use the transaction/predicate notation for UTXO based transactions from the Cerberus Channels paper \cite{cerberus}. We let $o = (x\,|\,P)$ to represent a UTXO that holds value $x$ and lists a predicate $P$ that locks or unlocks this UTXO. Predicate $P$ can be a base predicate (see list below) or a combination of base predicates with $\lor$ (\textit{OR}) or $\land$ (\textit{AND}) operators.
\begin{itemize}
    \item $\sigma_a$: Signature that matches\footnote{Bitcoin uses SIGHASH flags to control which part of a transaction is signed by whom. For simplicity, we assume what is being signed is clear from the context.} the public key $A$.
    \item $s \ni h(s) = H_s$: The spending transaction needs to provide a preimage $s$ whose hashed value is $H_s$.
    \item $\Delta_k$: A timelock of $k$ blocks needs to elapse to unlock the spending transaction.
\end{itemize}
A transaction is a mapping from a set of past UTXO's to a set future UTXO's, and can be represented as:
$$T_i = [o_j, o_k, \ldots] \mapsto [o_i^1, o_i^2, \ldots]$$
where $T_i$ consumes past UTXO's $o_j$, $o_k$, $\ldots$. to produce future UTXO's $\{o_i^1$, $o_i^2$, $\ldots\}$. Predicates that apprear on the left side of a transaction unlock the UTXOs in question, and those that appear on the right side lock the newly created UTXO's. An example transaction would look like:
$$T_i = [(2\,|\sigma_a), \underbrace{(1\,|\,\Delta_{10}), (3\,|s_x)}_{T_j}] \mapsto [(6\,|\,\sigma_b \land H_{s_y})]$$
$T_i$ is spending 3 UTXO's by providing a signature $\sigma_a$ for $A$ (Alice), waiting for time $\Delta_{10}$ (10 blocks), and a preimage $s_x$ such that the hash $h(s_x)$ was used to lock the 3rd UTXO that $T_i$ is spending. $T_i$ itself creates a new UTXO that has the coin value of 6, and can be spent by providing a signature for $B$ (Bob) and a preimage $s_y$ such that the hash $h(s_y) = H_{s_y}$. Additionally, the two spent UTXO's $(1\,|\,\Delta_{10}), (3\,|s_x)$ were created in a previous transaction $T_j$. The UTXO creating transaction (in the underbrace) is shown only if it's relevant to the protocol. In the above case, the UTXO $(2|\sigma_a)$ doesn't show a source UTXO under it, and can be assumed that the transacton from where Alice got her 2 bitcoins doesn't matter in this setting. 

\section{Atomic Swaps: Prior Work}
In this section, we formally define Tier Nolan's classic atomic swap \cite{atomic_swap} and two other sophisticated swap designs that avoid griefing to some extent but do not eliminate it. This formal treatment of these swaps reveals the scenarios where griefing happens, how premiums prevent griefing, and how premiums themselves can be griefed.

\subsection{Tier Nolan Atomic Swap}\label{sec:tn_swap}
In Tier Nolan's classic swap (TN-swap), Alice locks $P_a$ with a timelock (refunding $P_a$ back to her) and a hashlock (so Bob can redeem $P_a$). Bob locks $P_b$ symmetrically but with a lower value for the timelock. If one of the parties aborts, the other party can wait for their timelock to expire and refund their principals back to themselves. If neither party aborts, the swap completes with both parties redeeming the principals due to them. The blockchain acts as a public bulletin board that communicates the secret preimage of the hashlock from Alice to Bob. Alice's timelock is always longer than Bob's to account for Alice's head start in the protocol and knowing the preimage of the hashlock, which enables her to finish her side of the swap first. We use the word \textit{refund} when a party's principal comes back to them after a swap is abandoned, and the word \textit{redeem} when a party can complete a swap and get the counterparty's principal. The entire set of transactions that make up the TN-swap can be defined succinctly in our notation as shown in Figure \ref{fig:tier_nolan_atomic_swap}. 

\begin{figure}[hbt!]
    \centering
    \caption{Tier Nolan Atomic Swap}
    \label{fig:tier_nolan_atomic_swap}
\begin{align*}
    &S_{all} = \{T_0, T_1, T_2, T_3, T_4, T_5\} \\
    &T_0 = [(P_a|\sigma_a)] \mapsto [(P_a|(\sigma_a \land \Delta_2) \lor (\sigma_b \land H_{s}))] \\
    &T_1 = [(P_b|\sigma_b)] \mapsto [(P_b|(\sigma_a \land H_{s}) \lor (\sigma_b \land \Delta_1))] \\
    &T_2 = [\underbrace{(P_b|(\sigma_a \land s))}_{T_1}] \mapsto [(P_b|\sigma_a)]\\
    &T_3 = [\underbrace{(P_a|(\sigma_b \land s))}_{T_0}] \mapsto [(P_a|\sigma_b)]\\
    &T_4 = [\underbrace{(P_b|(\sigma_b \land \Delta_1))}_{T_1}] \mapsto [(P_b|(\sigma_b)] \\
    &T_5 = [\underbrace{(P_a|(\sigma_a \land \Delta_2))}_{T_1}] \mapsto [(P_a|(\sigma_a)] \\
    &S = \{T_0, T_1, T_2, T_3\} \\
    &F_1 = \{T_0, T_5\} \\
    &\text{\parbox{8cm}{[Bob aborts before committing $P_b$. Alice has to wait for $\Delta_2$, and gets no compensation]}} \\
    &F_2 = \{T_0, T_1, T_4\} \\
    &\text{\parbox{8cm}{[Alice aborts before redeeming $P_b$. Bob has to wait for $\Delta_1$, and gets no compensation]}}
\end{align*}
\end{figure}

\noindent
\textbf{Griefing}: Note that Alice and Bob both have the right to abort out of the swap before it happens. If either party aborts, their counterparty is left waiting for their timelock to expire before getting their refund. If Bob aborts, Alice has to wait for $\Delta_2$ to expire before refunding her principal $P_a$ back to her. If Alice aborts, Bob has to wait for $\Delta_1$ to refund his principal $P_b$ back to him. This leads to the notion of the locked value of funds or griefing. To account for this, we add a griefing cost to each subset $F_i$ in the atomic swap specification from Section \ref{spec}. If the griefing cost is zero for all failure subsets in the specification, we consider a protocol to be grief-free. Formally, let

\begin{equation} \label{eq:cost}
 cost = \sum{f(P_i\cdot \Delta_j)} \;\;\;\; \forall i \in \{a, b\}, j \in \{1, 2, 3, \ldots\}
\end{equation}

where $f(P_i\cdot \Delta_j)$ is the value of locking $P_i$ for duration $\Delta_j$. In the summation, a party's term $f(P_i\cdot \Delta_j)$ is introduced only if a counterparty has aborted. The timelocked value of the aborting party's principal or premium is not included in the griefing cost. TN-swap's costs for its two failure scenarios can be quantified as:
\begin{equation}\label{eq:tr_cost}
\begin{split}
    cost_{F_1} &= f(P_a\cdot \Delta_2) > 0\\
    cost_{F_2} &= f(P_b\cdot \Delta_1) > 0\\
\end{split}
\end{equation}

The idea of locking up the principal amount to enable swaps seems inherent to atomic swap protocols that use sequential transactions. To lower the griefing cost of locking up the principal, atomic swaps have been proposed that offer a premium as compensation to the locking party if their counterparty aborts from the swap. This premium's value is estimated using the Cox-Ross-Rubinstein model in \cite{atomic_swaps_american_call_options} using options pricing theory and the price volatility of the crypto-assets in question. We ignore the price volatility of the crypto assets and use a simple interest rate model to price the time value of the locked-up principal. This could be as simple as a simple interest rate, calculated by taking the product of the principal, length of the timelock, and an arbitrary interest rate $r$ that the parties agree upon. 
\begin{equation} 
 f(P_i\cdot \Delta_j) = \rho_i = P_i \cdot \Delta_j \cdot r \;\;\; \forall i \in \{a, b\}, j \in \{1, 2, 3, \ldots\} \\
\end{equation}

The total griefing cost of the protocol has to account for both the locked value of the principals and the equivalent premiums that are returned to the parties based on how the parties act during the protocol execution. Equation \ref{eq:cost} for cost can be modified as:

\begin{equation} \label{eq:cost_with_premium}
 cost = \sum{f(P_i\cdot \Delta_j}) - \sum{\rho_i} \;\;\; \forall i \in \{a, b\}, j \in \{1, 2, 3, \ldots\}
\end{equation}

If all the locked-up principals are compensated by corresponding premiums, $cost$ goes to zero. TN-swap's cost is strictly positive as it does not have compensatory premiums. Interestingly, in subsequent protocols we discuss, the premium $\rho_i$ could also be locked up for some timelock $\Delta_j$. In this case, this timelocked value of the premiums is recognized in the first term of the right-hand side of Equation \ref{eq:cost_with_premium}.

\subsection{Atomic Swaps with Premiums}
We now consider two constructions that offer a premium as compensation to the party that locks up capital during the swap. The Han-Lin-Yu atomic swap (HLY-swap), introduced in \cite{atomic_swaps_american_call_options} and the Xue-Herlihy Atomic Swap (XH-swap), introduced in \cite{xue_herlihy_swap}. Regarding the premium value itself, there are many approaches from the world of traditional finance to calculate the premium \cite{atomic_swaps_american_call_options}. This premium has to be baked into the swap protocol - so that it can be transferred from one party to another based on how the swap proceeds. If the blockchain in question supports stateful smart contracts, like Ethereum, this coupling between the premium and the swap can be implemented as shown in \cite{atomic_swaps_american_call_options}. If the blockchain does not support stateful smart contracts (Bitcoin does not), both \cite{atomic_swaps_american_call_options} and \cite{xue_herlihy_swap} suggest upgrading the scripting language of the blockchain to support it. This upgrade comes in the form of a new opcode that can scan the blockchain to see where the swapped assets ended up and then redirect the premium to that address. In other words, an opcode that can use information not available at the time of writing the contract. In Bitcoin, this opcode (called \texttt{OP\_LOOKUP\_OUTPUT} in \cite{atomic_swaps_american_call_options}) requires a separate index to be maintained by the nodes. Given how Bitcoin optimizes for a smaller footprint, such a new index is unlikely to be added in the future. To analyze these swaps that need \texttt{OP\_LOOKUP\_OUTPUT}, we introduce two new predicate types in our notation to represent what \texttt{OP\_LOOKUP\_OUTPUT} does.
\begin{itemize}
    \item $\overline{T_i.\Delta_j}$: A future transaction $T_i$ happens before $\Delta_j$.
    \item $\neg{\overline{T_i.\Delta_j}}$: A future transaction $T_i$ does not happen before $\Delta_j$.
\end{itemize}

\bigskip
\noindent
\textbf{HLY-swap:}
If we assume the \texttt{OP\_LOOKUP\_OUTPUT} opcode implemented by a combination of the above two predicates, HLY-swap can be implemented as shown in Figure \ref{fig:hly_swap}. This swap handles the second half of the griefing problem from TN-swap, but not the first. In TN-swap, Alice can grief Bob by not redeeming his principal by broadcasting \texttt{TN-T\textsubscript{3}} (transaction $T_3$ from the Tier Nolan swap in Figure \ref{fig:tier_nolan_atomic_swap}). In HLY Swap, Alice puts up a premium $\rho_a$ in \texttt{HLY-T\textsubscript{0}}, which will go back to Alice only if Alice goes along with her side of the swap in \texttt{HLY-T\textsubscript{3}}. If she aborts here, Bob doesn't have the secret preimage to redeem his side of the swap and has to wait for his timelock $\Delta_2$ to expire to get his principal back. To compensate for this grief, Bob gets to keep Alice's premium $\rho_a$ by broadcasting \texttt{HLY-T\textsubscript{7}}. This is covered in the scenario \texttt{HLY-F\textsubscript{2}}. 

\begin{figure}[hbt!]
    \centering
    \caption{Han-Lin-Yu Atomic Swap with 1 Premium}
    \label{fig:hly_swap}
\begin{align*}
    &S_{all} = \{T_0, T_1, T_2, T_3, T_4, T_5, T_6, T_7, T_8\} \\
    &T_0 = [(\rho_a |\sigma_a)] \mapsto [(\rho_a|((\sigma_a \land \sigma_b \land \Delta_4) \land \\ 
    &\phantomrel{========} {} (\overline{T_3.\Delta_2} \lor \overline{T_5.\Delta_4} \lor \overline{T_6.\Delta_4} \lor \neg \overline{T_2.\Delta_1}))]\\
    &T_1 = [(P_a|\sigma_a)] \mapsto [(P_a|(\sigma_a \land \Delta_3) \lor (\sigma_b \land H_{s}))]\\
    &T_2 = [(P_b|\sigma_b)] \mapsto [(P_b|(\sigma_a \land H_{s}) \lor (\sigma_b \land \Delta_2))]\\
    &T_3 = [\underbrace{(P_b|(\sigma_a \land s))}_{T_1}] \mapsto [(P_b |\sigma_a)]\\
    &T_4 = [\underbrace{(P_a|(\sigma_b \land s))}_{T_0}] \mapsto [(P_a|\sigma_b)]\\
    &T_5 = [\underbrace{(P_b|(\sigma_b \land \Delta_2))}_{T_2}] \mapsto [(P_b |(\sigma_b)]\\
    &T_6 = [\underbrace{(P_a|(\sigma_a \land \Delta_3))}_{T_1}] \mapsto [(P_a | (\sigma_a)]\\    
    &T_7 = [\underbrace{(\rho_a|(\sigma_a \land \sigma_b \land \Delta_4))}_{T_0}] \mapsto [(\rho_a | \sigma_b)]\\
    &T_8 = [\underbrace{(\rho_a|(\sigma_a \land \sigma_b \land \Delta_4))}_{T_0}] \mapsto [(\rho_a | \sigma_a)]\\    
    &S = \{T_0, T_1, T_2, T_3, T_4, T_8\} \\
    &\text{\parbox{8cm}{[Everything goes as per plan and Alice gets back her premium]}}\\
    &F_1 = \{T_0, T_1, T_6, T_8\} \\ 
    &\text{\parbox{8cm}{[Bob aborts before committing $P_b$. Alice gets no compensation]}}\\
    &F_2 = \{T_0, T_1, T_2, T_5, T_6, T_7\} \\ 
    &\text{\parbox{8cm}{[Alice aborts before redeeming $P_b$. Bob gets $\rho_a$ as compensation]}}
\end{align*}
\end{figure}

Note that HLY-swap does not compensate Alice in case Bob aborts before committing his principal. Alice has to wait for $\Delta_3$ before getting $P_a$ back in \texttt{HLY-T\textsubscript{6}} and $\Delta_4$ before getting back $\rho_a$ in \texttt{HLY-T\textsubscript{8}} (scenario \texttt{HLY-F\textsubscript{1}}). The griefing costs of HLY-swap are:

\begin{alignat}{2}
    cost_{F_1} &= f(\rho_a\cdot\Delta_4) + f(P_a\cdot\Delta_3) - \rho_a > 0 \label{eq:hly_cost_1} \\
    cost_{F_2} &= f(P_b\cdot\Delta_2) - \rho_a = 0 \label{eq:hly_cost_2}
\end{alignat}

As Alice aborts in failure scenario \texttt{HLY-F\textsubscript{2}}, only Bob's principal $P_b$ is included in Equation \ref{eq:hly_cost_2}. Bob's timelocked value $f(P_b.\Delta_2)$ is compensated by Alice's premium $\rho_a$, and hence cost of failure scenario \texttt{HLY-F\textsubscript{2}} $cost_{F_2} = 0$.

As Bob aborts in failure scenario \texttt{HLY-F\textsubscript{1}}, only Alice's principal $P_a$ is included in Equation \ref{eq:hly_cost_1}, and $cost_{F_1} > 0$. In fact, Alice gets extra grief here because her premium $\rho_a$ is also locked up for $\Delta_4$. The problem of Alice not being compensated for locking up her principal is solved in XH-swap.

\begin{figure}[hbt!]
    \centering
    \caption{Xue-Herlihy Atomic Swap with 2 Premiums}
    \label{fig:xh_swap}
\begin{align*}
    &S_{all} = \{T_0, T_1, T_2, T_3, T_4, T_5, T_6, T_7, T_8, T_9, T_{10}, T_{11}\} \\
    &T_0 = [(\rho_a |\sigma_a)] \mapsto [(\rho_a|((\sigma_a \land \sigma_b \land \Delta_5) \land \\
    &\phantomrel{======} {} ((\overline{T_3.\Delta_2} \land (\overline{T_4.\Delta_2} \lor \overline{T_6.\Delta_5})) \lor \neg \overline{T_3.\Delta_2}))] \\
    &T_1 = [(\rho_b |\sigma_b)] \mapsto [(\rho_b|((\sigma_a \land \sigma_b \land \Delta_6) \land \\
    &\phantomrel{======} {} ((\overline{T_2.\Delta_1} \land (\overline{T_5.\Delta_3} \lor \overline{T_7.\Delta_6})) \lor \neg \overline{T_2.\Delta_1}))] \\
    &T_2 = [(P_a|\sigma_a)] \mapsto [(P_a|(\sigma_a \land \Delta_4) \lor (\sigma_b \land H_{s}))] \\
    &T_3 = [(P_b|\sigma_b)] \mapsto [(P_b|(\sigma_a \land H_{s}) \lor (\sigma_b \land \Delta_3))] \\
    &T_4 = [\underbrace{(P_b|(\sigma_a \land s))}_{T_3}] \mapsto [(P_b |\sigma_a)]\\
    &T_5 = [\underbrace{(P_a|(\sigma_b \land s))}_{T_2}] \mapsto [(P_a|\sigma_b)]\\
    &T_6 = [\underbrace{(P_b|(\sigma_b \land \Delta_3))}_{T_3}] \mapsto [(P_b |(\sigma_b)] \\
    &T_7 = [\underbrace{(P_a|(\sigma_a \land \Delta_4))}_{T_2}] \mapsto [(P_a | (\sigma_a)] \\    
    &T_8 = [\underbrace{(\rho_a|(\sigma_a \land \sigma_b \land \Delta_5))}_{T_0}] \mapsto [(\rho_a | \sigma_a)]\\
    &T_9 = [\underbrace{(\rho_a|(\sigma_a \land \sigma_b \land \Delta_5))}_{T_0}] \mapsto [(\rho_a | \sigma_b)]\\
    &T_{10} = [\underbrace{(\rho_b|(\sigma_a \land \sigma_b \land \Delta_6))}_{T_1}] \mapsto [(\rho_b | \sigma_a)]\\
    &T_{11} = [\underbrace{(\rho_b|(\sigma_a \land \sigma_b \land \Delta_6))}_{T_1}] \mapsto [(\rho_b | \sigma_b)]\\
    &S = \{T_0, T_1, T_2, T_3, T_4, T_5, T_8, T_{11}\} \\
    &\text{\parbox{8cm}{[Everything goes as per plan and Alice gets back her premium]}} \\
    &F_1 = \{T_0, T_8\} \\
    &\text{\parbox{8cm}{[Bob aborts before committing $\rho_b$. Alice gets no compensation]}} \\
    &F_2 = \{T_0, T_1, T_8, T_{11}\} \\ 
    &\text{\parbox{8cm}{[Alice aborts before committing $P_a$. Bob gets no compensation]}} \\
    &F_3 = \{T_0, T_1, T_2, T_7, T_8, T_{10}\} \\ 
    &\text{\parbox{8cm}{[Bob aborts before committing $P_b$. Alice gets $\rho_b$ compensation]}} \\
    &F_4 = \{T_0, T_1, T_2, T_3, T_6, T_7, T_9, T_{10}\}\\
    &\text{\parbox{8cm}{[Alice aborts before redeeming $P_b$. Bob gets $(\rho_a-\rho_b)$ as compensation]}}
\end{align*}
\end{figure}

\bigskip
\noindent
\textbf{XH-swap:} XH-Swap, as shown in Figure \ref{fig:xh_swap}, requires both Alice and Bob to deposit premiums upfront: $\rho_a, \rho_b$, with $\rho_a > \rho_b$. This inequality ensures that in certain failure scenarios, if the smaller $\rho_b$ goes to Alice and the larger $\rho_a$ goes to Bob, Bob is effectively getting the premium $\rho_a-\rho_b$. If the principal amounts are equal ($P_a = P_b$), then Alice's premium is double that of Bob so that $\rho_a - \rho_b = \rho_b$. These premiums are committed to the blockchain upfront, with future-looking conditions (using the opcode \texttt{OP\_LOOKUP\_OUTPUT}) that govern whether these premiums go to Alice or Bob, depending on whether they take part in the swap, or abort the swap. The next set of transactions are equivalent to the TN-swap, but with additional conditions on where the premiums go. Due to the premiums being timelocked, two additional failure scenarios (on top of the two original failure scenarios of the TN-swap) have to be handled by XH-swap: parties aborting after their premiums are committed but before their principals are committed. Together, these four failure scenarios are shown in Figure \ref{fig:xh_swap}, where in each scenario, either Alice or Bob aborts, either after committing their premiums or principals. The griefing costs of XH-swap are:

\begin{alignat}{2}
    cost_{F_1} &= f(\rho_a\cdot\Delta_5) > 0 \label{eq:xh_cost_1}\\
    cost_{F_2} &= f(\rho_b\cdot\Delta_6) > 0 \label{eq:xh_cost_2}\\
    cost_{F_3} &= f(\rho_a\cdot\Delta_5) + f(P_a\cdot\Delta_4) - \rho_b = 0 \label{eq:xh_cost_3}\\
    cost_{F_4} &= f(\rho_b\cdot\Delta_6) + f(P_b\cdot\Delta_3) - (\rho_a - \rho_b) =0 \label{eq:xh_cost_4}
\end{alignat}

As XH-swap is explicitly designed to handle failure scenarios \texttt{XH-F\textsubscript{3}} and \texttt{XH-F\textsubscript{4}}, the griefing costs $C_{F_3}$ and $C_{F_4}$ are 0 in Equations \ref{eq:xh_cost_3} and \ref{eq:xh_cost_4}. However, XH-swap does not compensate Alice and Bob for their premiums. In case their counterparty aborts during the premium setup phase (\texttt{XH-F\textsubscript{1}} for Alice, or \texttt{XH-F\textsubscript{2}} for Bob) Alice and Bob receive no compensation. These are shown in Equations \ref{eq:xh_cost_1} and \ref{eq:xh_cost_2}. To get these griefing costs close to zero, the authors of XH-swap propose using smaller premiums to bootstrap larger premiums, till the premiums are sufficient enough to swap the principals. The first set of premiums in such a \textit{premium-chain} can be griefed, as it's backed by nothing. It is assumed that these premiums are small enough for Alice and Bob to ignore the griefing cost.

\subsection{Shortcomings of Atomic Swaps with Premiums} \label{section:shortcomings}
There are four shortcomings in these protocols with premiums: 
\begin{enumerate}
    \item They do not compensate for locked-up premiums.
    \item They are not compatible with Bitcoin.
    \item Their final timelock is much longer than the classic TN-swap.
    \item The the number of transactions under all scenarios (sizes of $S_{all}$, $S$, and $F_{i}$) are higher than the classic TN-swap.
\end{enumerate}

\noindent
These four shortcomings can all be attributed to a more fundamental idea that is embedded in these protocols -- which is that of separating the \textit{premium protocol} from the \textit{principal protocol}. The latter is the classic TN-swap, and the former is bolted on the TN-swap to make it partially grief-free. As we see next, if we couple the two protocols together, we can overcome all four shortcomings.

\section{Grief-free Atomic Swap}
\begin{figure}[hbt!]
    \centering
    \caption{Grief-Free Atomic Swap with 2 Premiums}
    \label{fig:grief_free_swap}
\begin{align*}
    &S_{all} = \{T_0, T_1, T_2, T_3, T_4, T_5, T_6, T_7\} \\
    &T_0 = [(\rho_a|\sigma_a)] \mapsto [(\rho_a|(\sigma_a \land \sigma_b) \lor (\sigma_a \land H_{s}))] \\
    &T_1 = [(P_a|\sigma_a), (\rho_b|\sigma_b)] \mapsto [((P_a+\rho_b)| \\
    &\phantomrel{=============} {} (\sigma_b \land H_{s}) \lor (\sigma_a \land \Delta_2))]\\
    &T_2 = [(P_b|\sigma_b), \underbrace{(\rho_a|(\sigma_a \land \sigma_b))}_{T_0}] \mapsto [((P_b+\rho_a)| \\
    &\phantomrel{=============} {} ((\sigma_a \land H_{s}) \lor (\sigma_b \land \Delta_1))]\\
    &T_3 = [\underbrace{((P_b+\rho_a)|(\sigma_a \land s))}_{T_2}] \mapsto [((P_b+\rho_a)|\sigma_a)]\\
    &T_4 = [\underbrace{((P_a+\rho_b)|(\sigma_b \land s))}_{T_1}] \mapsto [((P_a+\rho_b)|\sigma_b)]\\
    &T_5 = [\underbrace{(\rho_a|(\sigma_a \land s))}_{T_0}] \mapsto [(\rho_a|(\sigma_a)] \\
    &T_6 = [\underbrace{((P_a+\rho_b)|(\sigma_a \land \Delta_2))}_{T_1}] \mapsto [((P_a + \rho_b)|(\sigma_a)] \\
    &T_7 = [\underbrace{((P_b+\rho_a)|(\sigma_b \land \Delta_1))}_{T_2}] \mapsto [((P_b + \rho_a)|(\sigma_b)] \\
    &S = \{T_0, T_1, T_2, T_3, T_4\} \\
    &F_1 = \{T_0, T_5\} \\
    &\text{\parbox{8cm}{[Bob aborts before committing $\rho_b$. Alice loses nothing.]}} \\
    &F_2 = \{T_0, T_5\} \\ 
    &\text{\parbox{8cm}{[Alice aborts before committing $P_a$. Bob loses nothing.]}} \\
    &F_3 = \{T_0, T_1, T_6, T_5\} \\ 
    &\text{\parbox{8cm}{[Bob aborts before committing $P_b$. Alice gets $\rho_b$ as compensation]}} \\
    &F_4 = \{T_0, T_1, T_2, T_6, T_7\} \\ 
    &\text{\parbox{8cm}{[Alice aborts before redeeming $P_b$. Bob gets ($\rho_a-\rho_b$) as compensation]}}
\end{align*}
\end{figure}


% Define block styles
\tikzstyle{block} = [rectangle, rounded corners, minimum width=3cm, minimum height=1cm, text centered, text width=3cm, draw=black]
\begin{figure}
  \centering
  \captionsetup{justification=centering}
  \caption{Grief-free Atomic Swap - Transaction Flow}
  \begin{tikzpicture}[node distance=1.75cm]
    \node [block][label=left:1] (1)  {Alice prepares \texttt{GF-T\textsubscript{0}} and sends it to Bob};
    \node [block, below of=1][label=left:] (2) {Bob aborts};
    \node [block, right=1.5cm of 2][label=right:] (3) {Bob broadcasts \texttt{GF-T\textsubscript{0}}};
    \node [block, above=0.5cm of 3][label=right:] (4) {Alice broadcasts \texttt{GF-T\textsubscript{5}} (revealing $s$) to get back $\rho_a$};
    \node [block, below=0.5cm of 3][label=right:] (41) {Alice keeps $\rho_a$};
    \node [block, below of=2][label=left:2] (5) {Bob sends unsigned $\rho_b$  to Alice};
    \node [block, below of=5][label=left:] (6) {Alice aborts};
    \node [block, right =1.5cm of 6][label=right:] (7) {Bob keeps $\rho_b$};
    \node [block, below of=6][label=left:3] (8) {Alice prepares \texttt{GF-T\textsubscript{1}} and sends it to Bob};
    \node [block, below of=8][label=left:] (9) {Bob aborts};
    \node [block, right =1.5cm of 9][label=right:] (10) {Bob signs and broadcasts \texttt{GF-T\textsubscript{1}}};
    \node [block, above=0.5cm of 10][label=right:] (11) {Alice has to wait for $\Delta_2$ to get back $P_a$, but gets $\rho_b$ as compensation};
    \node [block, below=0.5cm of 10][label=right:] (12) {Alice keeps $P_a$} ;
    \node [block, below of=9][label=left:4] (13) {Bob prepares \texttt{GF-T\textsubscript{2}} and sends it to Alice};
    \node [block, below of=13] (14)[label=left:] {Alice aborts};
    \node [block, right =1.5cm of 14][label=right:] (15) {Bob keeps $P_b$ and $\rho_b$ as \texttt{GF-T\textsubscript{2}} is not broadcast yet};
    \node[below left=1cm and 0.1cm of 14] (141) {};
    \node[below right=1cm and 5cm of 14] (142) {};
    \node [block, below =1.75cm of 14][label=left:5] (16) {Bob signs and broadcasts \texttt{GF-T\textsubscript{1}}; Alice signs and broadcasts \texttt{GF-T\textsubscript{1}}; either Alice or Bob broadcast \texttt{GF-T\textsubscript{0}}};
    \node [block, below =0.75cm of 16][label=left:] (17) {Alice aborts};
    \node [block, right =1.5cm of 17][label=right:] (18) {Bob broadcasts \texttt{GF-T\textsubscript{7}}; Alice broadcasts \texttt{GF-T\textsubscript{6}}; Bob gets $\rho_a - \rho_b$ as compensation};
    \node [block, below =0.75cm of 17][label=left:6] (19) {Bob broadcasts \texttt{GF-T\textsubscript{3}}; Bob broadcasts \texttt{GF-T\textsubscript{4}}; Swap completes};
    \draw [arrows=-Stealth]
    (1) edge (2)
    (2) edge["Yes"] (3)
    (3) edge["Yes"] (4)
    (3) to["No"] (41)
    (2) edge["No"] (5)
    (5) edge (6)
    (6) edge["Yes"] (7)
    (6) edge["No"] (8)
    (8) edge (9)
    (9) edge["Yes"] (10)
    (10) edge["Yes"] (11)
    (10) edge["No"] (12)
    (9) edge["No"] (13)
    (13) edge (14)
    (14) edge["Yes"] (15)
    (14) edge["No"] (16)
    (16) edge (17)
    (17) edge["Yes"] (18)
    (17) edge["No"] (19)
    ;
    \draw[dashed] (141) -- node[below] {On-chain} node[above] {Off-chain} ++(142);
  \end{tikzpicture}
\label{fig:grief_free_swap_flow_chart}    
\end{figure}

Our Grief-free Atomic Swap (GF-swap) protocol's transactions are shown in Figure \ref{fig:grief_free_swap} and the actual flow of transactions between Alice and Bob are shown in the flowchart in Figure \ref{fig:grief_free_swap_flow_chart}. As said before, the key insight that makes the protocol grief-free is the coupling between the premium and the principal protocols. The coupling is accomplished in two separate points.
\begin{enumerate}
    \item A party's principal-committing transaction also commits to the counterparty's premium.
    \item The same secret preimage is used to lock principals and the premiums in their hashlock arms.
\end{enumerate}

Before we look at the swap in greater detail, a word about the premiums. As with the XH-swap, the GF-swap relies on the inequality $\rho_a > \rho_b$, given Alice and Bob's premiums $\rho_a, \rho_b$. The compensations that Alice and Bob get, in case they incur grief, are $\rho_b$ and $\rho_a - \rho_b$ respectively. If the atomic swap is happening across different blockchains, say Bitcoin and Litecoin, Alice's principal $P_a$ and Bob's premium $\rho_b$ are on Bitcoin while Bob's principal $P_b$ and Alice's premium $\rho_a$ are on Litecoin. If the swap is happening on the same blockchain, both principals and both premiums are on that blockchain.

\subsection{Setup}
Refer to Figure \ref{fig:grief_free_swap_flow_chart} for the following numbered steps.
\begin{enumerate}
    \item Alice creates \texttt{GF-T\textsubscript{0}}, which locks her premium $\rho_a$ such that it can be unlocked either by a multisig signed by both Alice and Bob, or just by Alice if she also reveals the secret preimage $s$ of hash $H_s$. Note that \texttt{GF-T\textsubscript{0}} has no timelock. Alice sends \texttt{GF-T\textsubscript{0}} to Bob so that he can inspect it. \texttt{GF-T\textsubscript{0}} is not broadcast to the blockchain yet.
    \item Bob hands over his premium $\rho_b$ to Alice off-chain. This premium is a UTXO that Bob controls. Bob can also prove that he can spend this UTXO by signing a standard ``Hello World" message with the public key that locks $\rho_b$. Note that such a signature just confirms to Alice that Bob controls $\rho_b$, and she cannot do anything else with such a signature.
    \item Alice constructs \texttt{GF-T\textsubscript{1}} which commits Alice's principal $P_a$. This transaction will also include include a reference to $\rho_b$. Alice sends \texttt{GF-T\textsubscript{1}} to Bob. Before signing \texttt{GF-T\textsubscript{1}}, Bob ensures that it pays Alice's premium to him if he reveals the secret preimage of the already known hash from \texttt{GF-T\textsubscript{0}}. Note that Bob has already seen \texttt{GF-T\textsubscript{0}} and can match the $H_s$ from \texttt{GF-T\textsubscript{0}} and \texttt{GF-T\textsubscript{1}}. \texttt{GF-T\textsubscript{1}} also has a refund arm going back to Alice, which has a timelock. 
    \item Bob then constructs his principal committing transaction \texttt{GF-T\textsubscript{2}} which also uses Alice's premium $\rho_a$. To do this, Alice has to give her signature to Bob so that the multisig that locks $\rho_a$ can be unlocked in \texttt{GF-T\textsubscript{2}}. Alice does this only if \texttt{GF-T\textsubscript{2}} sends both Bob's principal and Alice's premium ($P_b + \rho_a$) to Alice, if she reveals the preimage of the same hash $H_s$. \texttt{GF-T\textsubscript{2}} also has a refund arm going back to Bob, which has a timelock. 
\end{enumerate} 

The series of transactions \texttt{GF-T\textsubscript{0}}, \texttt{GF-T\textsubscript{1}}, and \texttt{GF-T\textsubscript{2}} can be constructed and signed off-chain in the specific order mentioned above, and broadcasted by either party in Step 5. Both \texttt{GF-T\textsubscript{1}} and \texttt{GF-T\textsubscript{2}} take two inputs each, a party's principal and the counterparty's premium, and send their sum to the redeeming party if they reveal the secret preimage, or refund it back to the party if they wait for timelocks to expire - just like in TN-swap. The principals and the premiums are coupled now. After the setup stage, we look at how the rest of the swap can play out, including success and failure scenarios.

\subsection{Success}
If the swap goes as per plan and we reach Step 6, Alice broadcasts \texttt{GF-T\textsubscript{3}} to redeem $P_b + \rho_a$ and Bob broadcasts \texttt{GF-T\textsubscript{4}} to redeem $P_a + \rho_b$. Both parties get their counterparty's principal and their own premiums back.

\subsection{Failures}
The protocol handles the four failure scenarios gracefully and grief-free. In the following failure scenarios, we look at only those cases where a party is being griefed due to their counterparty aborting. If a party aborts on their own volition and has to refund their principal amount back to themselves after a timelock, we do not consider it a failure scenario. 
\bigbreak
\noindent
\textbf{Bob aborts before committing \pmb{$\rho_b$}(\texttt{GF-F\textsubscript{1}}):}
During the off-chain interaction where \texttt{GF-T\textsubscript{0}}, \texttt{GF-T\textsubscript{1}}, and \texttt{GF-T\textsubscript{2}} are being constructed, Bob could abort and not give his signature to \texttt{GF-T\textsubscript{1}} even if Alice has constructed it properly. There are three possibilities here: 
\begin{enumerate}
    \item If nothing has been broadcast on the blockchain, there is no grief. 
    \item If \texttt{GF-T\textsubscript{0}}, \texttt{GF-T\textsubscript{1}}, and \texttt{GF-T\textsubscript{2}} are signed and broadcast, but not confirmed, Bob could double-spend $\rho_b$ in a parallel transaction. In this case, Alice gets back her premium without delay using \texttt{GF-T\textsubscript{5}} by revealing the preimage. Revealing this preimage is harmless to Alice as her principal (which can be withdrawn by Bob if he knows this preimage) cannot be confirmed on the blockchain as Bob made \texttt{GF-T\textsubscript{1}} invalid by spending $\rho_b$ elsewhere. If Bob is careless and makes only \texttt{GF-T\textsubscript{1}} invalid by spending $\rho_b$, and leaves \texttt{GF-T\textsubscript{2}} to confirm on the blockchain - he risks losing his principal $P_b$ as well, as Alice can broadcast \texttt{GF-T\textsubscript{3}} and claim both the principals and her own premium. If Bob wants to abort at this stage in good faith, he has to not give his signatures to Alice for \texttt{GF-T\textsubscript{1}} and \texttt{GF-T\textsubscript{2}}. Nothing hits the blockchain, and both parties lose nothing.
    \item Bob could abort without giving his signature to \texttt{GF-T\textsubscript{1}}, but also broadcast \texttt{GF-T\textsubscript{0}} to lock up Alice's premium. In this case, Alice cannot immediately broadcast \texttt{GF-T\textsubscript{5}} to get premium back as her own principal is at risk if she reveals the secret preimage $s$. She first has to make \texttt{GF-T\textsubscript{1}} invalid by spending her principal $P_a$ back to herself before broadcasting \texttt{GF-T\textsubscript{5}}. This does not count as grief because she is only waiting for blockchain confirmation time, and not her timelock time of $\Delta_2$.
\end{enumerate}
\bigbreak
\noindent
\textbf{Alice aborts before committing \pmb{$P_a$} (\texttt{GF-F\textsubscript{2}}):}
Alice's principal $P_a$ and Bob's premium $\rho_b$ are committed to the blockchain in a single transaction \texttt{GF-T\textsubscript{1}}, and hence this scneario cannot occur. As in, Alice cannot abort and still grief Bob because if Alice aborts here, Bob's premium never hits the blockchain and there is no question of griefing Bob.
\bigbreak
\noindent
\textbf{Bob aborts before committing \pmb{$P_b$}(\texttt{GF-F\textsubscript{3}}):}
After constructing, signing, and broadcasting \texttt{GF-T\textsubscript{0}}, \texttt{GF-T\textsubscript{1}}, and \texttt{GF-T\textsubscript{2}}, Bob could double spend $P_b$ in a parallel transaction, thereby making \texttt{GF-T\textsubscript{2}} invalid. Alice can then get Bob's premium by confirming \texttt{GF-T\textsubscript{6}}, and also get her own premium back with \texttt{GF-T\textsubscript{5}}. Note that \texttt{GF-T\textsubscript{5}} is valid because Bob made the other transaction spending $\rho_a$ (\texttt{GF-T\textsubscript{2}}) invalid by double spending $P_b$ elsewhere. Alice has to wait for the timelock of $\Delta_2$, and for that, she is compensated with Bob's premium $\rho_b$.

\bigbreak
\noindent
\textbf{Alice aborts before redeeming \pmb{$P_b$}(\texttt{GF-F\textsubscript{4}}):}
After constructing, signing, and broadcasting \texttt{GF-T\textsubscript{0}}, \texttt{GF-T\textsubscript{1}}, and \texttt{GF-T\textsubscript{2}}, it is Alice's turn to redeem $P_b$ by broadcasting \texttt{GF-T\textsubscript{3}}. If she doesn't do it while time $\Delta$ elapses, Bob claims his refund back with \texttt{GF-T\textsubscript{7}}. Alice could claim her own refund back with \texttt{GF-T\textsubscript{6}}. In this case, Bob gets Alice's premium $\rho_a$ and Alice gets Bob's premium $\rho_b$. As $\rho_a > \rho_b$, it is Bob who is compensated here with the premium $\rho_a - \rho_b$ because Alice aborted the swap.

\bigbreak
\noindent
\textbf{Setup Signatures:} 
During the construction and signing of \texttt{GF-T\textsubscript{0}}, \texttt{GF-T\textsubscript{1}}, and \texttt{GF-T\textsubscript{2}}, we have Bob signing for his premium in \texttt{GF-T\textsubscript{1}} and Alice signing her premium in \texttt{GF-T\textsubscript{2}} (created by \texttt{GF-T\textsubscript{0}}'s multisig output arm). Bob has to make sure that Alice has signed \texttt{GF-T\textsubscript{2}} and given him a copy before he signs \texttt{GF-T\textsubscript{1}}. This ordering solves two separate failure scenarios. 
\begin{enumerate}
    \item Bob waits for Alice to sign \texttt{GF-T\textsubscript{2}} and give him a copy before signing \texttt{GF-T\textsubscript{1}} himself and giving her a copy. So, we are now either in the scenarios \texttt{GF-F\textsubscript{1}}, \texttt{GF-F\textsubscript{2}}, or \texttt{GF-S}. Bob loses nothing in all of these.
    \item Alice signs \texttt{GF-T\textsubscript{2}}, but does not get Bob's signature on \texttt{GF-T\textsubscript{1}}. Bob has two choices now. 
    \begin{enumerate}
        \item Bob can either keep \texttt{GF-T\textsubscript{2}} without broadcasting it, and we are in \texttt{GF-F\textsubscript{1}} where Alice doesn't lose anything.
        \item Bob can broadcast \texttt{GF-T\textsubscript{2}}, and risk losing his principal $P_b$ to Alice as well. To avoid that, he has to sign and broadcast \texttt{GF-T\textsubscript{1}} and we are in \texttt{GF-F\textsubscript{4}}, or \texttt{GF-S}. Alice loses nothing in these.
    \end{enumerate}
\end{enumerate}

\bigbreak
\noindent
\textbf{Cost:} 
The griefing costs (in terms of timelocked value of funds) of GF-swap are:

\begin{alignat}{2}
    cost_{F_1} &= 0 \label{eq:gf_cost_1} = 0\\
    cost_{F_2} &= 0 \label{eq:gf_cost_2} = 0\\
    cost_{F_3} &= f(P_a\cdot\Delta_2) - \rho_b = 0 \label{eq:gf_cost_3}\\
    cost_{F_4} &= f(P_b\cdot\Delta_1) + f(\rho_b\cdot\Delta_2) - (\rho_a - \rho_b) = 0 \label{eq:gf_cost_4}
\end{alignat}

As seen in failure scenarios \texttt{GF-F\textsubscript{1}} and \texttt{GF-F\textsubscript{2}}, if parties abort before committing their principals, no timelocks are engaged, and we get $cost_{F_1} = 0$ and $cost_{F_2} = 0$ in Equations \ref{eq:gf_cost_1} and \ref{eq:gf_cost_2}. Additionally, in failure scenario \texttt{GF-F\textsubscript{3}}, $f(P_a\cdot\Delta_2)$ is compensated by $\rho_b$, and therefore $cost_{F_3} = 0$. Here, Alice's premium $\rho_a$ is never committed, and $\rho_b$ does not have to compensate for it. In failure scenario \texttt{GF-F\textsubscript{4}}, both $f(\rho_b\cdot\Delta_1)$ and $f(P_b\cdot\Delta_1)$ together have to be compensated by $\rho_a - \rho_b$ to get $cost_{F_4} = 0$. 
 
\subsection{Coupling Principal and Premium}
Section \ref{section:shortcomings} listed the four shortcomings of previous premium-based designs. By coupling the \textit{premium protocol} and the \textit{principal protocol}, GF-swap manages to avoid these shortcomings.

\bigbreak
\noindent
\textbf{Premium Lockup Compensation:} Coupling the principal and the premium protocols lets us use the same values of the timelock for both. This ensures that wherever the principal goes, with whatever delay, the premium also follows. The only catch here is Alice's premium, which is locked in \texttt{GF-T\textsubscript{0}}. But this specifically avoids a timelock and is hence grief-free.

\bigbreak
\noindent
\textbf{Bitcoin Compatibility:} Decoupling the two protocols forces the premium protocol to lookup where the principal was sent, which needs a new Bitcoin opcode \texttt{OP\_LOOKUP\_OUTPUT}. Coupling them sends the two: premium and principal, together to their destination, and we do not need \texttt{OP\_LOOKUP\_OUTPUT}. It can otherwise be argued that, from a software engineering perspective, decoupling the protocols is better than coupling them. But the moment we decouple the two protocols, there is no way to construct the premium protocol without knowing how the principal protocol will play out in the future. In our opinion, Bitcoin compatibility is as important as the software engineering decoupling.

\bigbreak
\noindent
\textbf{Timelock Length:} Coupling the protocols lets GF-swap keeps the timelock values of TN-swap, as the premiums themselves do not need separate timelocks of larger values. This reduces the time it takes to make a full swap, when compared to related work presented earlier.

\bigbreak
\noindent
\textbf{Number of Transactions:} Coupling let's us go just 1 transaction over TN-swap (\texttt{GF-T\textsubscript{0}}, which sets up Alice's premium $\rho_a$). It's an open question whether we can incorporate premiums into a grief-free protocol while keeping the total number of transactions the same as TN-swap.

\subsection{Disadvantages of Coupling:} As discussed before, we choose to couple the premium and principal protocols to achieve Bitcoin compatibility. As expected, this design ``anti-pattern" makes it harder to extend GF-swap to handle other use cases. Examples: Bribing free atomic swaps \cite{Nadahalli2021timelocked} \cite{mad_htlc}, Multi-party swaps across more than 2 blockchains \cite{herlihy2018atomic}, atomic swap enabled automated market makers. Out of these, the bribing-free atomic swap from \cite{Nadahalli2021timelocked} can be also made grief-free with minor tweaking of the transactions involved. Alice's timelocked refund arm from \texttt{GF-T\textsubscript{1}} has to be made to go through another layer to bring in the extra fees that Alice needs to commit to make the combined protocol bribe-free as well. 

Payment channels and atomic swaps both use HTLCs as a building block. The GF-swap has a modified version of the HTLC. It is an open question whether this modified HTLC can be used to construct payment channels.

\section{Conclusion}
We have proposed an atomic swap protocol that makes the classic Tier Nolan swap resilient to griefing while adding just one extra on-chain transaction. We compensate griefing by offering a \textit{premium} to the party that gets griefed. Most of the heavy-lifting in our swap is done off-chain, where the two parties communicate to establish the swap in the first place. Unlike other protocols, in our swap, both parties can abort the premium protocol off-chain and not on-chain. We also show that coupling the premium and the principal protocol makes the swap implementable in Bitcoin, where transaction execution does not have access to an external global state. The coupling also reduces transaction costs and the worst-case timelock. Unfortunately, this coupling makes the GF-swap non-trivial to extend to other applications without careful tweaking of transactions.
